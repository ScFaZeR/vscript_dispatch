-- Helper function to trigger dispatch from client
local function SendDispatch(alertName, message)
    local playerPed = PlayerPedId()
    local coords = GetEntityCoords(playerPed)

    local streetHash1, streetHash2 = GetStreetNameAtCoord(coords.x, coords.y, coords.z)
    local streetName = GetStreetNameFromHashKey(streetHash1)
    if streetHash2 ~= 0 then
        streetName = streetName .. ' / ' .. GetStreetNameFromHashKey(streetHash2)
    end
    local zoneHash = GetNameOfZone(coords.x, coords.y, coords.z)
    local zoneName = GetLabelText(zoneHash)

    local info = {
        street = streetName,
        zone = zoneName,
        zoneCode = zoneHash,
        alertName = alertName
    }

    TriggerServerEvent('vscript_dispatch:server:sendDispatch', alertName, coords, message, info)
end

exports('SendDispatch', SendDispatch)

-- =========================================================
--  COMMANDES DE TEST (bypass chance + cooldown)
--  Usage : /testdispatch [alertName] [coords?]
--  Ex    : /testdispatch shooting
--          /testdispatch gofast 123.4, 567.8, 20.0
--          /testdispatch robbery vector3(443.46, 5561.62, 780.18)
-- =========================================================

local testMessages = {
    vehicle_theft    = 'TEST - Vol de v√©hicule en cours !',
    shooting         = 'TEST - Coups de feu signal√©s !',
    robbery          = 'TEST - Braquage en cours !',
    fight            = 'TEST - Bagarre signal√©e !',
    antenna_hacked   = 'TEST - Antenne pirat√©e !',
    antenna_restored = 'TEST - Antenne r√©tablie !',
    gofast           = 'TEST - GoFast rep√©r√© !',
    carjack          = 'TEST - Carjack en cours !',
    officer_down     = 'TEST - OFFICIER √Ä TERRE - URGENCE !',
}

-- Helper pour parser les coordonn√©es (supporte x y z, x,y,z et vector3(x,y,z))
local function ParseCoords(args)
    if #args < 2 then return nil end

    -- On combine le reste des arguments pour g√©rer les espaces/parenth√®ses
    local raw = table.concat(args, " ", 2)
    local coords = {}

    -- On cherche tous les nombres (incluant n√©gatifs et d√©cimaux)
    for num in raw:gmatch("[%d%.%-]+") do
        table.insert(coords, tonumber(num))
    end

    if #coords >= 3 then
        return vector3(coords[1], coords[2], coords[3])
    end
    return nil
end

if Config.TestMode then
    RegisterCommand('testdispatch', function(source, args)
        local alertName = args[1]

        -- Lister les alertes disponibles
        if not alertName or alertName == 'list' then
            print('^3[vscript_dispatch] Alertes disponibles :^7')
            for name, _ in pairs(testMessages) do
                print('  ^2/testdispatch ' .. name .. '^7')
            end
            print('^3Usage avec position : /testdispatch [alerte] [x y z] ou [vector3]^7')
            Bridge.Notify('Alertes list√©es dans la console (F8).', 'primary')
            return
        end

        -- V√©rifier que l'alerte existe
        if not Config.Alerts[alertName] then
            Bridge.Notify('Alerte inconnue : "' .. alertName .. '". Tape /testdispatch list pour voir les alertes.',
                'error')
            return
        end

        -- Coordonn√©es simul√©es ou position actuelle
        local customCoords = ParseCoords(args)
        local coords = customCoords or GetEntityCoords(PlayerPedId())

        local streetHash1, streetHash2 = GetStreetNameAtCoord(coords.x, coords.y, coords.z)
        local streetName = GetStreetNameFromHashKey(streetHash1)
        if streetHash2 ~= 0 then
            streetName = streetName .. ' / ' .. GetStreetNameFromHashKey(streetHash2)
        end
        local zoneHash = GetNameOfZone(coords.x, coords.y, coords.z)
        local zoneName = GetLabelText(zoneHash)

        local info = {
            street = streetName,
            zone = zoneName,
            zoneCode = zoneHash,
            code = 'TEST',
            alertName = alertName
        }

        TriggerServerEvent('vscript_dispatch:server:sendDispatch', alertName, coords, testMessages[alertName] or 'TEST',
            info)

        if customCoords then
            Bridge.Notify(
                'üü¢ Test envoy√© : ' .. alertName .. ' @ ' .. math.floor(coords.x) .. ', ' .. math.floor(coords.y),
                'success')
            print('^2[vscript_dispatch] Test envoy√© √† distance : ' .. tostring(coords) .. '^7')
        else
            Bridge.Notify('üü¢ Test envoy√© : ' .. alertName .. ' (position actuelle)', 'success')
        end
    end, false)
end
